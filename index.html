<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Correções</title>
  </head>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
    crossorigin="anonymous"
  ></script>
  <body>
    <div class="container">
      <br />
      <div class="row">
        <div class="col m3">
          <div class="card" style="width: 18rem">
            <div class="card-body">
              <div
                class="spinner-border text-primary"
                role="status"
                id="loadingCard1"
              >
                <span class="sr-only"></span>
              </div>
              <h5 class="card-title" id="totalCorrecoes"></h5>

              <p class="card-text">Total corrigido até o momento</p>
            </div>
          </div>
        </div>

        <div class="col m3">
          <div class="card" style="width: 18rem">
            <div class="card-body">
              <div
                class="spinner-border text-primary"
                role="status"
                id="loadingCard2"
              >
                <span class="sr-only"></span>
              </div>
              <h5 class="card-title" id="valorTotalRecebido"></h5>
              <p class="card-text">Total recebido até o momento.</p>
            </div>
          </div>
        </div>

        <div class="col m3">
          <div class="card" style="width: 18rem">
            <div class="card-body">
              <div
                class="spinner-border text-primary"
                role="status"
                id="loadingCard3"
              >
                <span class="sr-only"></span>
              </div>
              <h5 class="card-title" id="totalDiasCorridos"></h5>
              <p class="card-text">Dias corridos.</p>
            </div>
          </div>
        </div>
      </div>
      <br />
      <div class="col m3">
        <a
          class="btn btn-primary"
          href="/correcao-api/salvarCorrecao.html"
          role="button"
          >Nova correção</a
        >
      </div>
      <br />
      <div class="spinner-border text-primary" role="status" id="loadingTabela">
        <span class="sr-only"></span>
      </div>
      <table class="table" id="tabelaCorrecoes"></table>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    var token = localStorage.getItem("token");

    if (!token || token === undefined) {
      window.location.href = "/correcao-api/login.html";
    }

    var apiSecret = "correcao-api-tataia-base64-producao";
    var headers = {
      "api-secret": apiSecret,
      Authorization: `bearer ${token}`,
    };

    const backEnd = "https://correcao-api.herokuapp.com";

    document.getElementById("loadingTabela").style.display = "block";
    document.getElementById("loadingCard1").style.display = "block";
    document.getElementById("loadingCard2").style.display = "block";
    document.getElementById("loadingCard3").style.display = "block";

    buscarTotaisCards();
    buscarCorrecoes();

    async function buscarTotaisCards() {
      await axios
        .get(`${backEnd}/api/correcoes/totais`, { headers })
        .then((data) => {
          document.getElementById("loadingCard1").style.display = "none";
          document.getElementById("loadingCard2").style.display = "none";
          document.getElementById("loadingCard3").style.display = "none";
          var totais = data.data;
          document.getElementById("totalCorrecoes").innerHTML =
            totais.totalCorrecoes;
          var valorTotalRecebidoFormatado = formatarMoeda(
            totais.valorTotalRecebido
          );
          document.getElementById(
            "valorTotalRecebido"
          ).innerHTML = valorTotalRecebidoFormatado;
          document.getElementById("totalDiasCorridos").innerHTML =
            totais.totalDiasCorridos;
        })
        .catch((error) => {
          if (error.response.status === 401) {
            window.location.href = "/correcao-api/login.html";
          }
          console.error(error);
        });
    }

    async function buscarCorrecoes() {
      var dadosTabela = `
        <thead>
          <tr>
            <th scope="col">Data</th>
            <th scope="col">Total corrigido</th>
            <th scope="col">Valor total</th>
            <th scope="col">Remover</th>
          </tr>
        </thead>
        <tbody>
        `;
      await axios
        .get(`${backEnd}/api/correcoes`, { headers })
        .then((data) => {
          document.getElementById("loadingTabela").style.display = "none";
          data.data.forEach((correcao) => {
            dadosTabela =
              dadosTabela +
              `<tr>
            <td>${correcao.dataCorrecao}</td>
            <td>${correcao.totalCorrigido}</td>
            <td>${formatarMoeda(correcao.valorTotal)}</td>
            <td>
            <button type="button" class="btn btn-danger" onclick="removerCorrecao(${
              correcao.id
            })">Remover</button></td>
          </tr>`;
          });
          dadosTabela = dadosTabela + "</tbody>";
          document.getElementById("tabelaCorrecoes").innerHTML = dadosTabela;
        })
        .catch((error) => {
          if (error.response.status === 401) {
            window.location.href = "/correcao-api/login.html";
          }
          console.error(error);
        });
    }

    function formatarMoeda(moeda) {
      valorStr = moeda.toString().replace(".", ",");
      console.log(valorStr);
      try {
        let array = valorStr.split(",");
        if (array[1].length === 1) {
          valorStr = valorStr + "0";
        }
      } catch (error) {
        valorStr = valorStr + ",00";
        console.error(error);
      }
      valorStr = "R$" + valorStr;
      return valorStr;
    }

    async function removerCorrecao(id) {
      document.getElementById("loadingTabela").style.display = "none";
      document.getElementById("loadingCard1").style.display = "none";
      document.getElementById("loadingCard2").style.display = "none";
      document.getElementById("loadingCard3").style.display = "none";
      await axios
        .delete(`${backEnd}/api/correcoes/${id}`, { headers })
        .then((data) => {
          location.reload();
        })
        .catch((error) => {
          if (error.response.status === 401) {
            window.location.href = "/correcao-api/login.html";
          }
          document.getElementById("error").innerHTML =
            error.response.data.message;
        });
    }
  </script>
</html>
